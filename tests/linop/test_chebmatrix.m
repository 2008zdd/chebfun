function pass = test_chebmatrix

%% Building blocks
dom = [-2 -0.5 1 2];
I = operatorBlock.eye(dom);
D = operatorBlock.diff(dom);
Z = operatorBlock.zeros(dom);
x = chebfun('x', dom);
u = sin(x.^2);
U = operatorBlock.mult(u);   

D5 = [ 
  -5.499999999999999   6.828427124746189  -2.000000000000000   1.171572875253810  -0.500000000000000
  -1.707106781186547   0.707106781186547   1.414213562373095  -0.707106781186548   0.292893218813452
   0.500000000000000  -1.414213562373095                   0   1.414213562373095  -0.500000000000000
  -0.292893218813452   0.707106781186548  -1.414213562373095  -0.707106781186547   1.707106781186547
   0.500000000000000  -1.171572875253810   2.000000000000000  -6.828427124746189   5.499999999999999
];

% D5 = [
%   -6.611846424776157   7.396890626978217  -1.108650999952038   0.527416977547750  -0.369672519021277   0.165862339223506
%    0.299860202570142  -2.649107403619997   2.603349167299539  -0.363213978699957   0.186960573879793  -0.077848561429522
%   -0.100000000000000   0.305572809000084  -2.094427190999916   2.094427190999916  -0.305572809000084   0.100000000000000
%    0.077848561429522  -0.186960573879794   0.363213978699957  -2.603349167299539   2.649107403619996  -0.299860202570142
%   -0.165862339223506   0.369672519021277  -0.527416977547750   1.108650999952038  -7.396890626978215   6.611846424776155];

%%
A = [ I,Z; D,U ];
M = matrix(A,[4 4 4]);
DD = blkdiag(2/1.5*D5,2/1.5*D5,2/1*D5);
[xx, ww] = chebpts([4 4 4], dom);
UU = diag(u(xx));

% err(1) = norm(cell2mat(M(:,1)) - [eye(15) ; DD]) + norm(cell2mat(M(:,2)) - [zeros(12) ; UU])
err(1) = norm( M - [ eye(15), zeros(15); DD, UU ]);

%% more complicated chebmatrix
A = [ I, x, -3*I; 
    functionalBlock.sum(dom), 5, functionalBlock.feval(dom(end),dom);
    D, chebfun(1,dom), U ];
M = matrix(A,[5 5 5]);
MM = [ eye(15), xx, -3*eye(15);  
    ww, 5, [zeros(1,14) 1];
    DD, ones(15,1), UU ];

err(2) = norm( M - MM );

%%
% application to an appropriate chebmatrix
v = [ exp(x); pi; cos(x) ];
Av = A*v;
err(3) = norm( (v{1} + pi*x -3*v{3}) - Av{1} );
err(4) = norm( sum(v{1})+5*v{2}+feval(v{3},dom(end)) - Av{2} );
err(5) = norm( diff(v{1})+pi+(u).*v{3} - Av{3} );

pass = err < 1e-14;

end
